# This workflow runs on every push to the main branch.
# It builds a -SNAPSHOT version of the plugin and uploads it to a "dev-latest" pre-release.
#  For buils on github, push tags:
#  - git tag v1.0.0
#  - git push origin --tags
name: Development Build

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  build-and-deploy-dev:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 22 and Maven Cache
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build for Development
        run: |
          # Try to get the latest tag starting with 'v'. If the command fails, it will not stop the script.
          LATEST_TAG=$(git describe --tags --abbrev=0 --match="v*" 2>/dev/null) || true
          if [ -z "$LATEST_TAG" ]; then
            echo "No version tags (v*) found. Using default version v8.1.3 for the build."
            LATEST_TAG="v8.1.3" # Default version if no tags exist
          fi
          TAG_VERSION=$(echo ${LATEST_TAG#v})
          echo "TAG_VERSION=${TAG_VERSION}" >> $GITHUB_ENV
          mvn -B clean install -Drevision=${TAG_VERSION}-SNAPSHOT -DBUILD_NUMBER=${{ github.run_number }} -Dmaven.javadoc.skip -Dmaven.source.skip -Dgpg.skip --file pom.xml
        env:
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Generate Dev Release Notes
        id: generate_dev_releasenotes
        run: |
          # Check if this is the first push to a new branch (github.event.before is all zeros)
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            echo "First push to a new branch. Listing all commits in this push."
            CHANGELOG=$(echo '${{ toJSON(github.event.commits) }}' | jq -r '.[].message' | sed 's/^/- /')
          else
            # Generate a changelog based on the commits in the push
            CHANGELOG=$(git log ${{ github.event.before }}..${{ github.event.after }} --pretty=format:"- %s")
          fi

          # Save the raw changelog as one output
          echo "raw_changelog<<EOF" >> $GITHUB_OUTPUT
          echo "${CHANGELOG}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Create the full release body and save as another output
          FULL_BODY="This is the latest development build from the master branch. Use with caution, it may contain bugs.
          
          ## Recent Changes
          ${CHANGELOG}"
          echo "full_body<<EOF" >> $GITHUB_OUTPUT
          echo "${FULL_BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload to Development Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: snapshot-b${{ github.run_number }}
          name: "SNAPSHOT - RedProtect v${{ env.TAG_VERSION }} - Build ${{ github.run_number }}"
          body: ${{ steps.generate_dev_releasenotes.outputs.full_body }}
          prerelease: true
          files: ./RedProtect-Spigot/target/RedProtect-${{ env.TAG_VERSION }}-SNAPSHOT-b${{ github.run_number }}-Spigot.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Discord Notification
        uses: appleboy/discord-action@master
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: |
            üõ†Ô∏è **New Snapshot Build: v${{ env.TAG_VERSION }}-SNAPSHOT** (Build #${{ github.run_number }})
            A new Snapshot build is available.
            
            **Recent Changes:**
            ```markdown
            ${{ steps.generate_dev_releasenotes.outputs.raw_changelog }}
            ```
            View Snapshot Release: https://github.com/${{ github.repository }}/releases/tag/snapshot-b${{ github.run_number }}
          username: RedProtect GitHub
